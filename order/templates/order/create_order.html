<h2>Create New Order</h2>

<form method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <h3>Order Items</h3>
    {{ formset.management_form }}
    <div id="order-items">
        {% for form in formset %}
            <div class="order-item">
                {{ form.as_p }}
                {% if form.instance.pk %}
                    <button type="button" class="delete-item">Delete</button>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    
    <button type="button" id="add-item">Add Another Product</button>
    <button type="submit">Submit</button>
</form>

<a href="{% url 'staff_dashboard' %}">Back to Dashboard</a>

<script>
    document.getElementById('add-item').addEventListener('click', function() {
        let formIdx = document.querySelectorAll('.order-item').length;
        let formsetContainer = document.getElementById('order-items');
        let newForm = document.createElement('div');
        newForm.classList.add('order-item');
        newForm.innerHTML = '{{ formset.empty_form.as_p|escapejs }}'.replace(/__prefix__/g, formIdx);
        formsetContainer.appendChild(newForm);
        
        // Update management form count
        let totalForms = document.getElementById('id_items-TOTAL_FORMS');
        totalForms.value = formIdx + 1;
    });

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-item')) {
            e.target.closest('.order-item').remove();
            let totalForms = document.getElementById('id_items-TOTAL_FORMS');
            totalForms.value = document.querySelectorAll('.order-item').length;
        }
    });
</script>
